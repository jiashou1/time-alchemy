<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êó∂Èó¥ÁÇºÈáëÊúØ v1.3.6 (LWW Stable)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains+Mono', monospace; background-color: #0a0a0a; color: #00ff41; min-height: 100vh; }
        .glass { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); border: 1px solid #333; }
        input, select { background: #1a1a1a !important; color: #00ff41 !important; border: 1px solid #444 !important; border-radius: 4px; padding: 6px 10px; outline: none; }
        .btn-action { padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .save-btn { background: #00ff41; color: #000; }
        .edit-btn { color: #666; border: 1px solid #333; font-size: 10px; padding: 2px 8px; border-radius: 4px; }
        .idea-card { border: 1px dashed #eab308; background: rgba(234, 179, 8, 0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CATEGORIES = {
            CORE: { id: 'CORE', label: 'Ê†∏ÂøÉ‰∫ßÂá∫', color: '#00ff41' },
            OPS: { id: 'OPS', label: '‰∫§ÊòìËøêÁª¥', color: '#0ea5e9' },
            FAMILY: { id: 'FAMILY', label: 'ÂÆ∂Â∫≠Êó∂ÂÖâ', color: '#ec4899' },
            WASTE: { id: 'WASTE', label: 'Êó†ÊïàÊçüËÄó', color: '#ef4444' },
            RECHARGE: { id: 'RECHARGE', label: 'ËÉΩÈáèÂÖÖÁîµ', color: '#eab308' },
            IDEA: { id: 'IDEA', label: 'Âç≥Êó∂ÊÉ≥Ê≥ï', color: '#eab308' }
        };

        const App = () => {
            const [logs, setLogs] = useState(() => {
                try {
                    const saved = localStorage.getItem('timeLogs');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });

            const [activeTask, setActiveTask] = useState(() => {
                try {
                    const saved = localStorage.getItem('activeTask');
                    return saved && saved !== "null" ? JSON.parse(saved) : null;
                } catch (e) { return null; }
            });

            const [config, setConfig] = useState(() => {
                try {
                    const saved = localStorage.getItem('syncConfig');
                    return saved ? JSON.parse(saved) : {token:"", gistId:""};
                } catch (e) { return {token:"", gistId:""}; }
            });
            
            const [showSettings, setShowSettings] = useState(false);
            const [syncing, setSyncing] = useState(false);
            const [feeling, setFeeling] = useState('');
            const [ideaText, setIdeaText] = useState('');
            const [currentCategory, setCurrentCategory] = useState('CORE');
            const [editingId, setEditingId] = useState(null);
            const [editDraft, setEditDraft] = useState(null);

            useEffect(() => {
                localStorage.setItem('timeLogs', JSON.stringify(logs));
                localStorage.setItem('activeTask', JSON.stringify(activeTask));
                localStorage.setItem('syncConfig', JSON.stringify(config));
            }, [logs, activeTask, config]);

            // --- Ê†∏ÂøÉÂêåÊ≠•ÈÄªËæëÔºöLWW (Last Write Wins) Á≠ñÁï• ---
            // --- Ê†∏ÂøÉÂêåÊ≠•ÈÄªËæë‰øÆÂ§çÔºöÁªïËøá React Èó≠ÂåÖÔºåÁõ¥Êé•ËØªÂèñÁâ©ÁêÜÂ≠òÂÇ® ---
            const syncData = async (mode = 'sync', silent = false) => {
                if (!config.token || !config.gistId) return;
                setSyncing(true);
                try {
                    // 1. ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÁõ¥Êé•‰ªé localStorage ËØªÂèñÊúÄÊñ∞Êï∞ÊçÆÔºåÁ°Æ‰øùÂåÖÂê´ÂàöÂàöÁöÑÊìç‰Ωú
                    const currentLocalLogs = JSON.parse(localStorage.getItem('timeLogs') || '[]');
                    
                    const timestamp = Date.now();
                    const response = await fetch(`https://api.github.com/gists/${config.gistId}?_t=${timestamp}`, {
                        headers: { 'Authorization': `token ${config.token}`, 'Accept': 'application/vnd.github.v3+json' },
                        cache: 'no-store'
                    });

                    let cloudContent = [];
                    if (response.ok) {
                        const gistData = await response.json();
                        const fileContent = gistData.files['data.json']?.content;
                        if (fileContent) {
                            const parsed = JSON.parse(fileContent);
                            cloudContent = Array.isArray(parsed) ? parsed : [];
                        }
                    }

                    let finalLogs = [];
                    if (mode === 'pull') {
                        finalLogs = cloudContent;
                    } else {
                        // 2. LWW (Last Write Wins) ÂÜ≤Á™ÅË£ÅÂÜ≥Á≠ñÁï•
                        const uniqueMap = new Map();
                        
                        // ÂÖàÊîæ‰∫ëÁ´ØÊï∞ÊçÆÔºåÂÜçÊîæÊú¨Âú∞ÊúÄÊñ∞Êï∞ÊçÆ
                        // Â¶ÇÊûú ID Áõ∏ÂêåÔºåupdatedAt Êõ¥Â§ßÁöÑÔºàÂç≥Êõ¥Êñ∞ÁöÑÔºâ‰ºöË¶ÜÁõñÊóßÁöÑ
                        [...cloudContent, ...currentLocalLogs].forEach(item => {
                            if (!item || !item.id) return;
                            const existing = uniqueMap.get(item.id);
                            const itemTime = item.updatedAt || item.id;
                            const existingTime = existing ? (existing.updatedAt || existing.id) : 0;
                            
                            // Âè™ÊúâÂΩìÊù°ÁõÆÊõ¥Êñ∞ÔºåÊàñÂéüÊú¨‰∏çÂ≠òÂú®Êó∂ÊâçÂÜôÂÖ•
                            if (!existing || itemTime >= existingTime) {
                                uniqueMap.set(item.id, item);
                            }
                        });
                        finalLogs = Array.from(uniqueMap.values()).sort((a, b) => b.id - a.id);
                    }

                    // 3. Â∞ÜÂêàÂπ∂ÂêéÁöÑÊúÄÁªàÁä∂ÊÄÅÊé®Âêë‰∫ëÁ´Ø
                    const updateResponse = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                        method: 'PATCH',
                        headers: { 
                            'Authorization': `token ${config.token}`, 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({ 
                            files: { 'data.json': { content: JSON.stringify(finalLogs) } } 
                        })
                    });

                    if (!updateResponse.ok) throw new Error("Gist ÂÜôÂÖ•Â§±Ë¥•");

                    // 4. ÂèçÂêëÊõ¥Êñ∞ React Áä∂ÊÄÅÔºå‰øùÊåÅ UI ‰∏ÄËá¥
                    setLogs(finalLogs);
                    // ÂêåÊó∂‰πüÁ°Æ‰øùÊú¨Âú∞ÊåÅ‰πÖÂåñÔºàÂèå‰øùÈô©Ôºâ
                    localStorage.setItem('timeLogs', JSON.stringify(finalLogs));
                    
                    if (!silent) alert("‰∫ëÁ´ØÊï∞ÊçÆÂêåÊ≠•ÂÆåÊàê");
                } catch (err) {
                    console.error("Sync Error:", err);
                    if (!silent) alert("ÂêåÊ≠•ÂºÇÂ∏∏: " + err.message);
                } finally {
                    setSyncing(false);
                }
            };

            const startTask = () => {
                const now = new Date();
                setActiveTask({ 
                    id: Date.now(), 
                    category: currentCategory, 
                    startTime: now.toISOString(), 
                    feeling,
                    updatedAt: Date.now()
                });
                setFeeling('');
            };

            const stopTask = () => {
                if (!activeTask) return;
                const now = new Date();
                const completedTask = { 
                    ...activeTask, 
                    endTime: now.toISOString(), 
                    duration: Math.max(1, Math.round((now - new Date(activeTask.startTime)) / 1000 / 60)),
                    updatedAt: Date.now()
                };
                setLogs([completedTask, ...logs]);
                setActiveTask(null);
                setTimeout(() => syncData('sync', true), 500);
            };

            const saveQuickIdea = () => {
                if (!ideaText.trim()) return;
                const newIdea = { 
                    id: Date.now(), 
                    category: 'IDEA', 
                    startTime: new Date().toISOString(), 
                    feeling: ideaText, 
                    duration: 0,
                    updatedAt: Date.now()
                };
                setLogs([newIdea, ...logs]);
                setIdeaText('');
                setTimeout(() => syncData('sync', true), 500);
            };

            const saveEdit = () => {
                const updatedDraft = { ...editDraft, updatedAt: Date.now() };
                const newLogs = logs.map(l => l.id === editingId ? updatedDraft : l);
                setLogs(newLogs);
                setEditingId(null);
                setEditDraft(null);
                setTimeout(() => syncData('sync', true), 500);
            };

            const deleteLog = (id) => {
                if(window.confirm("Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü")) {
                    // 1. Â¢ìÁ¢ëÊú∫Âà∂Ê†áËÆ∞Âà†Èô§
                    const newLogs = logs.map(l => 
                        l.id === id ? { ...l, deleted: true, updatedAt: Date.now() } : l
                    );
                    setLogs(newLogs);
                    
                    // 2. Ê†∏ÂøÉ‰ºòÂåñÔºöÂà†Èô§ÂêéÁ´ãÂç≥ÈáçÁΩÆÁºñËæëÁä∂ÊÄÅÔºåËøîÂõû‰∏ªÂàóË°®È°µÈù¢
                    setEditingId(null);
                    setEditDraft(null);
                    
                    // 3. Ëß¶ÂèëËá™Âä®ÂêåÊ≠•
                    setTimeout(() => syncData('sync', true), 500);
                }
            };

            const formatDateTime = (isoString) => {
                const date = new Date(isoString);
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                return isToday ? timeStr : `${date.getMonth()+1}/${date.getDate()} ${timeStr}`;
            };

            return (
                <div className="max-w-md mx-auto p-4 pb-20">
                    <header className="mb-6 pt-4 flex justify-between items-center border-b border-gray-900 pb-4">
                        <h1 className="text-xl font-bold text-[#00ff41]">Êó∂Èó¥ÁÇºÈáëÊúØ v1.3.6</h1>
                        <div className="flex items-center gap-3">
                            <span className="text-[9px] text-gray-500">{syncing ? 'ÂêåÊ≠•‰∏≠...' : 'Âú®Á∫ø'}</span>
                            <button onClick={() => setShowSettings(!showSettings)} className="text-gray-500 text-xl">‚öôÔ∏è</button>
                        </div>
                    </header>

                    {showSettings && (
                        <div className="glass p-5 rounded-xl mb-6 border-blue-500/50">
                            <h3 className="text-xs font-bold mb-4 text-blue-400">ÈÖçÁΩÆ‰∏≠ÂøÉ</h3>
                            <div className="space-y-4">
                                <input type="password" value={config.token} onChange={e => setConfig({...config, token: e.target.value})} placeholder="GitHub Token" className="w-full text-xs" />
                                <input type="text" value={config.gistId} onChange={e => setConfig({...config, gistId: e.target.value})} placeholder="Gist ID" className="w-full text-xs" />
                                <div className="flex gap-2">
                                    <button onClick={() => syncData('pull')} className="btn-action bg-gray-800 text-white flex-1">ÊãâÂèñ‰∫ëÁ´Ø</button>
                                    <button onClick={() => setShowSettings(false)} className="btn-action save-btn flex-1">‰øùÂ≠òÂπ∂ÂÖ≥Èó≠</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {!editingId && (
                        <div className="space-y-4 mb-8">
                            <div className="glass p-3 rounded-xl border-dashed border-[#eab308]/40 flex gap-2">
                                <input type="text" placeholder="üí° ÁÅµÊÑüÊÉ≥Ê≥ï..." value={ideaText} onChange={e => setIdeaText(e.target.value)} onKeyDown={e => e.key === 'Enter' && saveQuickIdea()} className="flex-1 text-xs" />
                                <button onClick={saveQuickIdea} className="bg-[#eab308] text-black px-3 py-1 rounded text-xs font-bold">ËÆ∞‰∏ã</button>
                            </div>

                            <div className="glass p-5 rounded-xl border-[#00ff41]/20">
                                <div className="grid grid-cols-3 gap-2 mb-4">
                                    {Object.values(CATEGORIES).filter(c => c.id !== 'IDEA').map(cat => (
                                        <button key={cat.id} onClick={() => setCurrentCategory(cat.id)} className={`text-[10px] py-2 rounded border transition-all ${currentCategory === cat.id ? 'border-[#00ff41] bg-[#00ff41]/10 text-[#00ff41]' : 'border-gray-800 text-gray-500'}`}>{cat.label}</button>
                                    ))}
                                </div>
                                <input type="text" placeholder="ËÆ∞ÂΩïÊ≠§Âàª..." value={feeling} onChange={e => setFeeling(e.target.value)} className="w-full text-sm mb-4 bg-transparent border-b border-gray-800 pb-1" />
                                {!activeTask ? (
                                    <button onClick={startTask} className="w-full bg-[#00ff41] text-black font-bold py-3 rounded text-sm">ÂºÄÂßãËÆ∞ÂΩï</button>
                                ) : (
                                    <button onClick={stopTask} className="w-full bg-red-600 text-white font-bold py-3 rounded text-sm animate-pulse">ÂÅúÊ≠¢Âπ∂ÂêåÊ≠•</button>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="space-y-3">
                        {/* ÂÖ≥ÈîÆ‰øÆÂ§çÔºöËøáÊª§ÊéâÂ∑≤Âà†Èô§ËÆ∞ÂΩï */}
                        {logs.filter(l => !l.deleted).map(log => (
                            <div key={log.id} className={`glass p-4 rounded-xl ${log.category === 'IDEA' ? 'idea-card' : ''}`}>
                                {editingId === log.id ? (
                                    <div className="space-y-4">
                                        <div className="flex gap-2">
                                            <select value={editDraft.category} onChange={e => setEditDraft({...editDraft, category: e.target.value})} className="text-xs flex-1">
                                                {Object.values(CATEGORIES).map(c => <option key={c.id} value={c.id}>{c.label}</option>)}
                                            </select>
                                            {editDraft.category !== 'IDEA' && (
                                                <div className="flex items-center gap-1">
                                                    <input type="number" value={editDraft.duration} onChange={e => setEditDraft({...editDraft, duration: parseInt(e.target.value) || 0})} className="w-16 text-xs text-center" />
                                                    <span className="text-[10px] text-gray-500">min</span>
                                                </div>
                                            )}
                                        </div>
                                        <input type="text" value={editDraft.feeling} onChange={e => setEditDraft({...editDraft, feeling: e.target.value})} className="w-full text-xs" />
                                        <div className="flex justify-between items-center">
                                            <button onClick={() => deleteLog(log.id)} className="text-[10px] text-red-500">Âà†Èô§</button>
                                            <div className="flex gap-2">
                                                <button onClick={() => setEditingId(null)} className="text-[10px] text-gray-500 px-2">ÂèñÊ∂à</button>
                                                <button onClick={saveEdit} className="text-[10px] text-[#00ff41] font-bold border border-[#00ff41] px-3 py-1 rounded">‰øùÂ≠ò</button>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-[9px] font-bold px-1 rounded" style={{backgroundColor: CATEGORIES[log.category]?.color + '22', color: CATEGORIES[log.category]?.color}}>{CATEGORIES[log.category]?.label}</span>
                                                <span className="text-[9px] text-gray-600 font-bold">{formatDateTime(log.startTime)}</span>
                                            </div>
                                            <div className="text-xs text-gray-300 leading-relaxed">{log.feeling || "..." }</div>
                                        </div>
                                        <div className="flex flex-col items-end gap-2 ml-4">
                                            {log.category !== 'IDEA' && <div className="text-sm font-bold text-[#00ff41]">{log.duration}m</div>}
                                            <button onClick={() => { setEditingId(log.id); setEditDraft({...log}); }} className="edit-btn">ÁºñËæë</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
