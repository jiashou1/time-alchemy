<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êó∂Èó¥ÁÇºÈáëÊúØ v1.7.1</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains+Mono', monospace; background-color: #0a0a0a; color: #00ff41; min-height: 100vh; }
        .glass { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); border: 1px solid #333; }
        input, select, textarea { background: #1a1a1a !important; color: #00ff41 !important; border: 1px solid #444 !important; border-radius: 4px; padding: 6px 10px; outline: none; }
        .save-btn { background: #00ff41; color: #000; font-weight: bold; }
        .edit-btn { color: #666; border: 1px solid #333; font-size: 10px; padding: 2px 8px; border-radius: 4px; }
        .idea-card { border: 1px dashed #eab308; background: rgba(234, 179, 8, 0.05); }
        .q-tag { font-size: 9px; padding: 2px 8px; border-radius: 99px; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; cursor: pointer; }
        .active-tag { background: #00ff4122; color: #00ff41; border-color: #00ff4155; }
        .highlight-tag { font-size: 9px; padding: 1px 6px; border-radius: 99px; background: rgba(0, 255, 65, 0.15); color: #00ff41; border: 1px solid rgba(0, 255, 65, 0.3); margin-right: 4px; }
        .auto-resize-textarea { field-sizing: content; min-height: 1.5rem; resize: none; border: none !important; background: transparent !important; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #0a0a0a; border-top: 1px solid #222; z-index: 50; }
        .md h1,.md h2,.md h3 { color: #00ff41; font-weight: bold; margin: 12px 0 6px; }
        .md h1 { font-size: 14px; } .md h2 { font-size: 13px; } .md h3 { font-size: 12px; }
        .md p { margin: 6px 0; font-size: 11px; color: #ccc; line-height: 1.6; }
        .md ul,.md ol { margin: 6px 0 6px 16px; font-size: 11px; color: #ccc; }
        .md li { margin: 3px 0; line-height: 1.5; }
        .md strong { color: #00ff41; font-weight: bold; }
        .md em { color: #eab308; }
        .md hr { border-color: #333; margin: 12px 0; }
        .md code { background: #1a1a1a; color: #0ea5e9; padding: 1px 4px; border-radius: 3px; font-size: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CATEGORIES = {
            CORE: { id: 'CORE', label: '‰∫§ÊòìÁ†îÁ©∂', color: '#00ff41' },
            AI: { id: 'AI', label: 'AIÊé¢Á¥¢', color: '#0ea5e9' },
            FAMILY: { id: 'FAMILY', label: 'ÂÆ∂Â∫≠Êó∂ÂÖâ', color: '#ec4899' },
            RECREATION: { id: 'RECREATION', label: '‰ºëÈó≤Â®±‰πê', color: '#8b5cf6' },
            WASTE: { id: 'WASTE', label: 'Êó†ÊïàÊçüËÄó', color: '#ef4444' },
            RECHARGE: { id: 'RECHARGE', label: 'Êó•Â∏∏‰ª£Ë∞¢', color: '#eab308' },
            IDEA: { id: 'IDEA', label: 'Âç≥Êó∂ÊÉ≥Ê≥ï', color: '#eab308' }
        };

        const DEFAULT_TAGS = "‰∫§ÊòìÁ†îÁ©∂:Â§çÁõò,ÁõØÁõò,ÂºÄ‰ªì;AIÊé¢Á¥¢:ÊèêÁ§∫ËØç,ÊµãËØï,ÈòÖËØª;ÂÆ∂Â∫≠Êó∂ÂÖâ:ÈÖçÂÅ∂,Â≠©Â≠ê,Áà∂ÊØç;Êó•Â∏∏‰ª£Ë∞¢:Áù°Ëßâ,È•ÆÈ£ü,Ê¥óÊº±,Â¶ÇÂéï";

        const generateId = () => typeof crypto.randomUUID === 'function' ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).substring(2);

        const App = () => {
            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('timeLogs') || '[]'));
            const [activeTask, setActiveTask] = useState(() => JSON.parse(localStorage.getItem('activeTask') || 'null'));
            const [config, setConfig] = useState(() => JSON.parse(localStorage.getItem('syncConfig') || `{"token":"","gistId":"","tagMap":"${DEFAULT_TAGS}","apiKey":"","modelName":"gemini-3-flash-preview"}`));
            const [syncing, setSyncing] = useState(false);
            const [feeling, setFeeling] = useState('');
            const [ideaText, setIdeaText] = useState('');
            const [currentCategory, setCurrentCategory] = useState('CORE');
            const [selectedQuickTags, setSelectedQuickTags] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [editDraft, setEditDraft] = useState(null);
            const [editQuickTags, setEditQuickTags] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [showBackfill, setShowBackfill] = useState(false);
            const [backfillData, setBackfillData] = useState({ start: "", end: "" });
            const [tempConfig, setTempConfig] = useState(null);
            const [activeTab, setActiveTab] = useState('log');
            const [reviewPeriod, setReviewPeriod] = useState('today');
            const [reviewMessages, setReviewMessages] = useState([]);
            const [reviewLoading, setReviewLoading] = useState(false);
            const [reviewInput, setReviewInput] = useState('');

            useEffect(() => { localStorage.setItem('timeLogs', JSON.stringify(logs)); }, [logs]);
            useEffect(() => { localStorage.setItem('activeTask', JSON.stringify(activeTask)); }, [activeTask]);
            useEffect(() => { localStorage.setItem('syncConfig', JSON.stringify(config)); }, [config]);

            const displayLogs = useMemo(() => logs.filter(l => !l.deleted).sort((a, b) => new Date(b.startTime) - new Date(a.startTime)), [logs]);

            // ÂΩìÂâçÂàÜÁ±ªÁöÑÂø´Êç∑Ê†áÁ≠æÔºàÁî®‰∫éËÆ°Êó∂ÂíåË°•ÂΩïÔºâ
            const currentSubTags = useMemo(() => {
                try {
                    const label = CATEGORIES[currentCategory]?.label;
                    if (!config.tagMap || !label) return [];
                    const lines = config.tagMap.split(/[\n;]/);
                    const targetLine = lines.find(line => {
                        const trimmed = line.trim();
                        return trimmed.startsWith(label + ":") || trimmed.startsWith(label + "Ôºö");
                    });
                    if (!targetLine) return [];
                    const content = targetLine.includes(':') ? targetLine.split(':')[1] : targetLine.split('Ôºö')[1];
                    return content.split(',').map(t => t.trim()).filter(t => t !== "");
                } catch (e) { return []; }
            }, [currentCategory, config.tagMap]);

            // ÁºñËæëÊÄÅÂàÜÁ±ªÁöÑÂø´Êç∑Ê†áÁ≠æ
            const editSubTags = useMemo(() => {
                try {
                    const label = CATEGORIES[editDraft?.category]?.label;
                    if (!config.tagMap || !label) return [];
                    const lines = config.tagMap.split(/[\n;]/);
                    const targetLine = lines.find(line => {
                        const trimmed = line.trim();
                        return trimmed.startsWith(label + ":") || trimmed.startsWith(label + "Ôºö");
                    });
                    if (!targetLine) return [];
                    const content = targetLine.includes(':') ? targetLine.split(':')[1] : targetLine.split('Ôºö')[1];
                    return content.split(',').map(t => t.trim()).filter(t => t !== "");
                } catch (e) { return []; }
            }, [editDraft?.category, config.tagMap]);

            const toLocalISO = (iso) => {
                if (!iso) return "";
                const d = new Date(iso);
                return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            };
            const formatTime = (iso) => { const d = new Date(iso); return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; };
            const formatDT = (iso) => { const d = new Date(iso); return `${d.getMonth()+1}/${d.getDate()} ${formatTime(iso)}`; };

            const syncData = async (currLogs, mode = 'sync') => {
                if (!config.token || !config.gistId) return;
                setSyncing(true);
                try {
                    const res = await fetch(`https://api.github.com/gists/${config.gistId}?_t=${Date.now()}`, { headers: { 'Authorization': `token ${config.token}` }, cache: 'no-store' });
                    let cloud = []; 
                    if (res.ok) { 
                        const d = await res.json(); 
                        cloud = JSON.parse(d.files['data.json']?.content || '[]'); 
                    }
                    let final;
                    if (mode === 'pull') {
                        final = cloud;
                    } else {
                        const map = new Map(); 
                        [...cloud, ...currLogs].forEach(i => { 
                            if(i.id && (!map.has(i.id) || (i.updatedAt||0) > (map.get(i.id).updatedAt||0))) map.set(i.id, i); 
                        });
                        final = Array.from(map.values());
                    }
                    if (mode !== 'pull') {
                        await fetch(`https://api.github.com/gists/${config.gistId}`, {
                            method: 'PATCH', headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files: { 'data.json': { content: JSON.stringify(final) } } })
                        });
                    }
                    setLogs(final);
                    if (mode === 'pull') alert("‰∫ëÁ´ØÂêåÊ≠•ÊàêÂäü");
                } catch (e) { alert("ÂêåÊ≠•Â§±Ë¥•: " + e.message); } finally { setSyncing(false); }
            };

            const stopTask = () => {
                const now = new Date();
                const prefix = selectedQuickTags.length > 0 ? `[@${selectedQuickTags.join('/')}] ` : "";
                const newTask = { ...activeTask, category: currentCategory, feeling: prefix + feeling, endTime: now.toISOString(), duration: Math.max(1, Math.round((now - new Date(activeTask.startTime)) / 60000)), updatedAt: Date.now() };
                const newLogs = [newTask, ...logs];
                setLogs(newLogs); setActiveTask(null); setFeeling(''); setSelectedQuickTags([]); syncData(newLogs);
            };

            const renderContent = (text) => {
                if (!text) return null;
                const match = text.match(/^\[@(.+?)\]\s*(.*)/);
                if (match) {
                    return (
                        <div className="text-xs">
                            <div className="flex flex-wrap gap-1 mb-1">{match[1].split('/').map(m => <span key={m} className="highlight-tag">{m}</span>)}</div>
                            <div className="text-gray-300 break-words whitespace-pre-wrap">{match[2]}</div>
                        </div>
                    );
                }
                return <div className="text-xs text-gray-300 break-words whitespace-pre-wrap">{text}</div>;
            };

            // ÁÆÄÊòì Markdown Ê∏≤Êüì
            const renderMarkdown = (text) => {
                if (!text) return null;
                const lines = text.split('\n');
                const elements = [];
                let i = 0;
                while (i < lines.length) {
                    const line = lines[i];
                    if (line.startsWith('### ')) { elements.push(<h3 key={i}>{line.slice(4)}</h3>); }
                    else if (line.startsWith('## ')) { elements.push(<h2 key={i}>{line.slice(3)}</h2>); }
                    else if (line.startsWith('# ')) { elements.push(<h1 key={i}>{line.slice(2)}</h1>); }
                    else if (line.startsWith('---')) { elements.push(<hr key={i} />); }
                    else if (line.startsWith('- ') || line.startsWith('* ')) {
                        const items = [];
                        while (i < lines.length && (lines[i].startsWith('- ') || lines[i].startsWith('* '))) {
                            items.push(<li key={i} dangerouslySetInnerHTML={{__html: lines[i].slice(2).replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>')}} />);
                            i++;
                        }
                        elements.push(<ul key={`ul-${i}`}>{items}</ul>);
                        continue;
                    }
                    else if (/^\d+\. /.test(line)) {
                        const items = [];
                        while (i < lines.length && /^\d+\. /.test(lines[i])) {
                            items.push(<li key={i} dangerouslySetInnerHTML={{__html: lines[i].replace(/^\d+\. /,'').replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>')}} />);
                            i++;
                        }
                        elements.push(<ol key={`ol-${i}`}>{items}</ol>);
                        continue;
                    }
                    else if (line.trim() !== '') {
                        elements.push(<p key={i} dangerouslySetInnerHTML={{__html: line.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>').replace(/`(.+?)`/g,'<code>$1</code>')}} />);
                    }
                    i++;
                }
                return <div className="md">{elements}</div>;
            };

            // ÊûÑÂª∫Â§çÁõòÊï∞ÊçÆ
            const buildReviewData = (period) => {
                const now = new Date();
                const startOf = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
                const cutoff = period === 'today'
                    ? startOf(now)
                    : new Date(startOf(now).getTime() - 6 * 86400000);
                const periodLogs = logs.filter(l => !l.deleted && l.category !== 'IDEA' && new Date(l.startTime) >= cutoff);
                if (periodLogs.length === 0) return null;
                // ÂàÜÁ±ªÊ±áÊÄª
                const summary = {};
                periodLogs.forEach(l => {
                    if (!summary[l.category]) summary[l.category] = 0;
                    summary[l.category] += (l.duration || 0);
                });
                const summaryText = Object.entries(summary)
                    .map(([k, v]) => `${CATEGORIES[k]?.label || k}Ôºö${v}ÂàÜÈíü`)
                    .join('Ôºå');
                // ÂéüÂßãËÆ∞ÂΩï
                const recordsText = periodLogs
                    .sort((a,b) => new Date(a.startTime) - new Date(b.startTime))
                    .map(l => {
                        const tags = l.feeling?.match(/^\[@(.+?)\]/)?.[1] || '';
                        const note = l.feeling?.replace(/^\[@.+?\]\s*/, '') || '';
                        return `${formatDT(l.startTime)}-${formatTime(l.endTime)} [${CATEGORIES[l.category]?.label}]${tags ? ' #'+tags.replace(/\//g,'#') : ''} ${l.duration}ÂàÜÈíü${note ? ' | '+note : ''}`;
                    }).join('\n');
                return { summaryText, recordsText, periodLogs, summary };
            };

            // Ë∞ÉÁî® Gemini API
            const callGemini = async (messages) => {
                const apiKey = config.apiKey;
                const model = config.modelName || 'gemini-3-flash-preview';
                if (!apiKey) throw new Error('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠Â°´ÂÜô Gemini API Key');
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: messages })
                });
                if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || 'ËØ∑Ê±ÇÂ§±Ë¥•'); }
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || 'Êó†ËøîÂõûÂÜÖÂÆπ';
            };

            // ÂèëËµ∑Â§çÁõòÂàÜÊûê
            const startReview = async () => {
                const data = buildReviewData(reviewPeriod);
                if (!data) { alert('ËØ•Êó∂Èó¥ÊÆµÊöÇÊó†ËÆ∞ÂΩï'); return; }
                const periodLabel = reviewPeriod === 'today' ? '‰ªäÊó•' : 'Êú¨Âë®';
                const systemPrompt = `‰Ω†ÊòØÁî®Êà∑ÁöÑÊó∂Èó¥ÁÆ°ÁêÜÈ°æÈóÆÔºåËØ∑Âü∫‰∫é‰ª•‰∏ãÊó∂Èó¥ËÆ∞ÂΩïÊï∞ÊçÆËøõË°åÂàÜÊûêÔºåÁî®‰∏≠ÊñáÂõûÁ≠î„ÄÇ

ÂàÜÊûêÂë®ÊúüÔºö${periodLabel}
ÂàÜÁ±ªÊó∂ÈïøÊ±áÊÄªÔºö${data.summaryText}

ÂéüÂßãËÆ∞ÂΩïÔºö
${data.recordsText}

ËØ∑Êåâ‰ª•‰∏ãÊ†ºÂºèËæìÂá∫Ôºö

## Ê†∏ÂøÉÁªìËÆ∫
Ôºà3-5Êù°ÔºåÊØèÊù°‰∏ÄÂè•ËØùÔºåÁõ¥ÂáªÂÖ≥ÈîÆÈóÆÈ¢òÔºåÁî® - ÂàóÂá∫Ôºâ

---

## ÂÆåÊï¥Â§çÁõò
ÔºàÊåâÂàÜÁ±ªÂ±ïÂºÄÂàÜÊûêÔºåÁªìÂêàÂ§áÊ≥®ÂÜÖÂÆπÂà§Êñ≠Êó∂Èó¥Ë¥®ÈáèÔºåÁªôÂá∫ÂÖ∑‰ΩìÂèØÊâßË°åÁöÑÊîπËøõÂª∫ËÆÆÔºâ`;
                const initMessages = [{ role: 'user', parts: [{ text: systemPrompt }] }];
                setReviewMessages([{ role: 'user', text: `üìä ${periodLabel}Â§çÁõòÂàÜÊûê`, isSystem: true }]);
                setReviewLoading(true);
                try {
                    const reply = await callGemini(initMessages);
                    setReviewMessages([
                        { role: 'user', text: `üìä ${periodLabel}Â§çÁõòÂàÜÊûê`, isSystem: true },
                        { role: 'model', text: reply, _history: initMessages }
                    ]);
                } catch(e) { alert('ÂàÜÊûêÂ§±Ë¥•Ôºö' + e.message); setReviewMessages([]); }
                finally { setReviewLoading(false); }
            };

            // ËøΩÈóÆ
            const sendFollowUp = async () => {
                if (!reviewInput.trim() || reviewLoading) return;
                const lastModel = [...reviewMessages].reverse().find(m => m.role === 'model');
                if (!lastModel) return;
                const history = [...lastModel._history, { role: 'model', parts: [{ text: lastModel.text }] }, { role: 'user', parts: [{ text: reviewInput }] }];
                const userText = reviewInput;
                setReviewInput('');
                setReviewMessages(prev => [...prev, { role: 'user', text: userText }]);
                setReviewLoading(true);
                try {
                    const reply = await callGemini(history);
                    setReviewMessages(prev => [...prev, { role: 'model', text: reply, _history: history }]);
                } catch(e) { alert('ËØ∑Ê±ÇÂ§±Ë¥•Ôºö' + e.message); }
                finally { setReviewLoading(false); }
            };

            return (
                <div className="max-w-md mx-auto p-4 pb-20">
                    <header className="mb-6 pt-4 flex justify-between items-center border-b border-gray-900 pb-4">
                        <h1 className="text-xl font-bold text-[#00ff41]">Êó∂Èó¥ÁÇºÈáëÊúØ v1.7.1</h1>
                        <button onClick={() => { setTempConfig({...config}); setShowSettings(true); }} className="text-gray-500 text-xl">‚öôÔ∏è</button>
                    </header>

                    {showSettings && tempConfig && (
                        <div className="glass p-5 rounded-xl mb-6 border-blue-500/50 text-[10px] space-y-4">
                            <input type="password" value={tempConfig.token} onChange={e => setTempConfig({...tempConfig, token: e.target.value})} placeholder="GitHub Token" className="w-full" />
                            <input type="text" value={tempConfig.gistId} onChange={e => setTempConfig({...tempConfig, gistId: e.target.value})} placeholder="Gist ID" className="w-full" />
                            <div>
                                <label className="text-gray-500 block mb-1">ÂÖ®Ê†áÁ≠æÂø´Êç∑ÈÖçÁΩÆ (ÊØèË°å‰∏Ä‰∏™ÂàÜÁ±ª)</label>
                                <textarea 
                                    value={tempConfig.tagMap} 
                                    onChange={e => setTempConfig({...tempConfig, tagMap: e.target.value})} 
                                    className="w-full h-32 text-[10px] p-2 bg-black leading-relaxed" 
                                />
                            </div>
                            <div className="border-t border-gray-800 pt-4 space-y-3">
                                <label className="text-gray-500 block">AI Â§çÁõòËÆæÁΩÆ</label>
                                <input type="password" value={tempConfig.apiKey||''} onChange={e => setTempConfig({...tempConfig, apiKey: e.target.value})} placeholder="Gemini API Key" className="w-full" />
                                <input type="text" value={tempConfig.modelName ?? ''} onChange={e => setTempConfig({...tempConfig, modelName: e.target.value})} placeholder="Ê®°ÂûãÂêçÁß∞ (Â¶Ç gemini-3-flash-preview)" className="w-full" />
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => syncData(logs, 'pull')} className="bg-gray-800 text-white flex-1 py-2 rounded">‰ªé‰∫ëÁ´ØË¶ÜÁõñ</button>
                                <button onClick={() => { setConfig({...tempConfig}); setShowSettings(false); }} className="save-btn flex-1 py-2 rounded text-black font-bold">‰øùÂ≠òÁîüÊïà</button>
                            </div>
                        </div>
                    )}

                    <div className="glass p-3 rounded-xl border-dashed border-[#eab308]/40 flex items-end gap-2 mb-6">
                        <textarea placeholder="üí° Áû¨Êó∂ÁÅµÊÑü..." value={ideaText} onChange={e => setIdeaText(e.target.value)} className="auto-resize-textarea flex-1 text-xs py-1" />
                        <button onClick={() => { if(!ideaText.trim())return; const n=[{id:generateId(),category:'IDEA',startTime:new Date().toISOString(),endTime:new Date().toISOString(),feeling:ideaText,updatedAt:Date.now()},...logs]; setLogs(n); setIdeaText(''); syncData(n); }} className="bg-[#eab308] text-black px-3 py-1.5 rounded text-xs font-bold">ËÆ∞‰∏ã</button>
                    </div>

                    {activeTab === 'log' && (<>
                    <div className="mb-6">
                        <div className="grid grid-cols-3 gap-2">
                            {Object.values(CATEGORIES).filter(c=>c.id!=='IDEA').map(c => (
                                <button 
                                    key={c.id} 
                                    onClick={() => {
                                        setCurrentCategory(c.id); 
                                        setSelectedQuickTags([]); 
                                        if(activeTask) setActiveTask({...activeTask, category: c.id});
                                    }} 
                                    className={`text-[10px] py-2 rounded border transition-all ${currentCategory === c.id ? 'border-[#00ff41] bg-[#00ff41]/10 text-[#00ff41]' : 'border-gray-800 text-gray-500'}`}
                                >
                                    {c.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {!editingId && ( activeTask ? (
                        <div className="glass p-5 rounded-xl border-[#00ff41]/40 mb-8 shadow-lg shadow-[#00ff41]/5 animate-in fade-in zoom-in-95 duration-200">
                            <div className="flex justify-between items-center mb-4">
                                <span className="text-[10px] font-bold text-[#00ff41]">
                                    ÂΩìÂâçÂàÜÁ±ªÔºö{CATEGORIES[currentCategory].label}
                                </span>
                                <span className="text-[10px] animate-pulse text-red-500 font-bold uppercase tracking-wider">Logging...</span>
                            </div>
                            
                            {currentSubTags.length > 0 && (
                                <div className="flex flex-wrap gap-2 mb-4">
                                    {currentSubTags.map(t => (
                                        <button key={t} onClick={() => setSelectedQuickTags(p => p.includes(t) ? p.filter(x => x!==t) : [...p, t])} className={`q-tag ${selectedQuickTags.includes(t) ? 'active-tag' : 'text-gray-500'}`}>{t}</button>
                                    ))}
                                </div>
                            )}
                            
                            <textarea placeholder="Êúâ‰ªÄ‰πàÊÉ≥ËÆ∞ÂΩïÁöÑÔºü" value={feeling} onChange={e => setFeeling(e.target.value)} rows="1" className="auto-resize-textarea w-full text-sm mb-4 border-b border-gray-800" />
                            <button onClick={stopTask} className="w-full bg-red-600 text-white font-bold py-3 rounded text-sm transition-transform active:scale-95">ÂÅúÊ≠¢Âπ∂ÂêåÊ≠•</button>
                        </div>
                    ) : (
                        <div className="space-y-4 mb-8">
                            <div className="glass p-5 rounded-xl">
                                <button onClick={() => setActiveTask({ id: generateId(), category: currentCategory, startTime: new Date().toISOString(), updatedAt: Date.now() })} className="w-full bg-[#00ff41] text-black font-bold py-3 rounded text-sm transition-transform active:scale-95">ÂºÄÂßãËÆ∞ÂΩï</button>
                                <div className="flex justify-center text-[10px] text-gray-500 mt-4">
                                    <button onClick={() => { setShowBackfill(!showBackfill); setBackfillData({start:toLocalISO(new Date(Date.now()-3600000).toISOString()), end:toLocalISO(new Date().toISOString())}); setSelectedQuickTags([]); setFeeling(''); }} className="border-b border-gray-800 text-gray-400">+ Ë°•ÂΩïÂéÜÂè≤</button>
                                </div>
                                {showBackfill && (
                                    <div className="mt-4 pt-4 border-t border-gray-800 space-y-4">
                                        <div className="flex gap-2">{[15, 30, 60].map(m => <button key={m} onClick={() => { const now=new Date(); setBackfillData({start:toLocalISO(new Date(now.getTime()-m*60000).toISOString()), end:toLocalISO(now.toISOString())}) }} className="flex-1 py-1.5 border border-gray-700 rounded text-[10px]">{m}mÂâç</button>)}</div>
                                        <div className="space-y-2 text-[10px]">
                                            <div className="flex items-center gap-2 text-gray-500"><span>ÂºÄÂßã</span><input type="datetime-local" value={backfillData.start} onChange={e => setBackfillData({...backfillData, start: e.target.value})} className="flex-1" /></div>
                                            <div className="flex items-center gap-2 text-gray-500"><span>ÁªìÊùü</span><input type="datetime-local" value={backfillData.end} onChange={e => setBackfillData({...backfillData, end: e.target.value})} className="flex-1" /></div>
                                        </div>
                                        {currentSubTags.length > 0 && (
                                            <div className="flex flex-wrap gap-2">
                                                {currentSubTags.map(t => (
                                                    <button key={t} onClick={() => setSelectedQuickTags(p => p.includes(t) ? p.filter(x => x!==t) : [...p, t])} className={`q-tag ${selectedQuickTags.includes(t) ? 'active-tag' : 'text-gray-500'}`}>{t}</button>
                                                ))}
                                            </div>
                                        )}
                                        <textarea placeholder="Êúâ‰ªÄ‰πàÊÉ≥ËÆ∞ÂΩïÁöÑÔºü" value={feeling} onChange={e => setFeeling(e.target.value)} rows="2" className="w-full text-xs p-2 rounded" style={{background:'#111', border:'1px solid #333'}} />
                                        <button onClick={() => {
                                            const s=new Date(backfillData.start); const e=new Date(backfillData.end);
                                            const prefix = selectedQuickTags.length > 0 ? `[@${selectedQuickTags.join('/')}] ` : "";
                                            const n=[{id:generateId(), category:currentCategory, startTime:s.toISOString(), endTime:e.toISOString(), duration:Math.max(1,Math.round((e-s)/60000)), feeling: prefix + feeling, updatedAt:Date.now()}, ...logs];
                                            setLogs(n); setFeeling(''); setSelectedQuickTags([]); setShowBackfill(false); syncData(n);
                                        }} className="w-full py-2 bg-gray-800 text-[#00ff41] rounded text-[10px] font-bold border border-[#00ff41]/30">Á°ÆËÆ§Ë°•ÂΩï</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}

                    <div className="space-y-3">
                        {displayLogs.map(log => (
                            <div key={log.id} className={`glass p-4 rounded-xl ${log.category === 'IDEA' ? 'idea-card' : 'border-gray-800'}`}>
                                {editingId === log.id ? (
                                    <div className="space-y-4">
                                        <select value={editDraft.category} onChange={e => { setEditDraft({...editDraft, category: e.target.value}); setEditQuickTags([]); }} className="text-xs w-full">
                                            {Object.values(CATEGORIES).map(c => <option key={c.id} value={c.id}>{c.label}</option>)}
                                        </select>
                                        {editDraft.category !== 'IDEA' && (
                                            <div className="space-y-2 text-[10px]">
                                                <div className="flex items-center gap-2 text-gray-500"><span>ÂºÄÂßã</span><input type="datetime-local" value={toLocalISO(editDraft.startTime)} onChange={e => { const s=new Date(e.target.value); const end=new Date(editDraft.endTime); setEditDraft({...editDraft, startTime:s.toISOString(), duration:Math.max(1,Math.round((end-s)/60000))}); }} className="flex-1" /></div>
                                                <div className="flex items-center gap-2 text-gray-500"><span>ÁªìÊùü</span><input type="datetime-local" value={toLocalISO(editDraft.endTime)} onChange={e => { const s=new Date(editDraft.startTime); const end=new Date(e.target.value); setEditDraft({...editDraft, endTime:end.toISOString(), duration:Math.max(1,Math.round((end-s)/60000))}); }} className="flex-1" /></div>
                                            </div>
                                        )}
                                        {editSubTags.length > 0 && (
                                            <div className="flex flex-wrap gap-2">
                                                {editSubTags.map(t => (
                                                    <button key={t} onClick={() => {
                                                        const next = editQuickTags.includes(t) ? editQuickTags.filter(x => x!==t) : [...editQuickTags, t];
                                                        setEditQuickTags(next);
                                                        const bare = editDraft.feeling.replace(/^\[@.+?\]\s*/, '');
                                                        const prefix = next.length > 0 ? `[@${next.join('/')}] ` : "";
                                                        setEditDraft({...editDraft, feeling: prefix + bare});
                                                    }} className={`q-tag ${editQuickTags.includes(t) ? 'active-tag' : 'text-gray-500'}`}>{t}</button>
                                                ))}
                                            </div>
                                        )}
                                        <textarea value={editDraft.feeling} onChange={e => setEditDraft({...editDraft, feeling: e.target.value})} className="w-full text-xs min-h-[80px]" />
                                        <div className="flex justify-end gap-2">
                                            <button onClick={() => { if(confirm("Âà†Èô§Ôºü")){ const n=logs.map(l=>l.id===log.id?{...l, deleted:true, updatedAt:Date.now()}:l); setLogs(n); setEditingId(null); setEditQuickTags([]); syncData(n); } }} className="text-[10px] text-red-500 px-3 py-1">Âà†Èô§</button>
                                            <button onClick={() => { setEditingId(null); setEditQuickTags([]); }} className="text-[10px] px-3 py-1 text-gray-500">ÂèñÊ∂à</button>
                                            <button onClick={() => { const n=logs.map(l=>l.id===editingId?{...editDraft, updatedAt:Date.now()}:l); setLogs(n); setEditingId(null); setEditQuickTags([]); syncData(n); }} className="text-[10px] text-[#00ff41] border border-[#00ff41] px-4 py-1 rounded font-bold">Êõ¥Êñ∞</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1 overflow-hidden">
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="text-[9px] font-bold px-1.5 py-0.5 rounded" style={{backgroundColor: CATEGORIES[log.category]?.color+'22', color: CATEGORIES[log.category]?.color}}>{CATEGORIES[log.category]?.label}</span>
                                                <span className="text-[9px] text-gray-600">{log.category==='IDEA'?formatDT(log.startTime):`${formatDT(log.startTime)} - ${formatTime(log.endTime)}`}</span>
                                            </div>
                                            {renderContent(log.feeling)}
                                        </div>
                                        <div className="flex flex-col items-end shrink-0 ml-4 gap-2">
                                            {log.category!=='IDEA' && <div className="text-sm font-bold text-[#00ff41]">{log.duration}m</div>}
                                            <button onClick={() => {
                                                setEditingId(log.id);
                                                setEditDraft({...log});
                                                const match = log.feeling?.match(/^\[@(.+?)\]/);
                                                setEditQuickTags(match ? match[1].split('/') : []);
                                            }} className="edit-btn">ÁºñËæë</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                    </>)}

                    {activeTab === 'review' && (
                        <div className="space-y-4">
                            {/* Âë®ÊúüÂàáÊç¢ */}
                            <div className="flex gap-2">
                                {[{id:'today',label:'‰ªäÊó•Â§çÁõò'},{id:'week',label:'Êú¨Âë®Â§çÁõò'}].map(p => (
                                    <button key={p.id} onClick={() => { setReviewPeriod(p.id); setReviewMessages([]); }} className={`flex-1 py-2 rounded text-[11px] border transition-all ${reviewPeriod===p.id ? 'border-[#00ff41] bg-[#00ff41]/10 text-[#00ff41]' : 'border-gray-800 text-gray-500'}`}>{p.label}</button>
                                ))}
                            </div>

                            {/* Êï∞ÊçÆÊëòË¶ÅÈ•ºÂõæ */}
                            {(() => {
                                const data = buildReviewData(reviewPeriod);
                                if (!data) return <div className="text-center text-gray-600 text-xs py-4">ËØ•Êó∂Èó¥ÊÆµÊöÇÊó†ËÆ∞ÂΩï</div>;
                                const entries = Object.entries(data.summary).sort((a, b) => b[1] - a[1]);
                                const total = entries.reduce((s, [,v]) => s + v, 0);
                                // ÊûÑÂª∫È•ºÂõæÊâáÂΩ¢Ë∑ØÂæÑ
                                const cx = 80, cy = 80, r = 70, innerR = 36;
                                let cumAngle = -Math.PI / 2;
                                const slices = entries.map(([k, v]) => {
                                    const angle = (v / total) * 2 * Math.PI;
                                    const x1 = cx + r * Math.cos(cumAngle);
                                    const y1 = cy + r * Math.sin(cumAngle);
                                    const x2 = cx + r * Math.cos(cumAngle + angle);
                                    const y2 = cy + r * Math.sin(cumAngle + angle);
                                    const ix1 = cx + innerR * Math.cos(cumAngle);
                                    const iy1 = cy + innerR * Math.sin(cumAngle);
                                    const ix2 = cx + innerR * Math.cos(cumAngle + angle);
                                    const iy2 = cy + innerR * Math.sin(cumAngle + angle);
                                    const large = angle > Math.PI ? 1 : 0;
                                    const d = `M ${ix1} ${iy1} L ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} L ${ix2} ${iy2} A ${innerR} ${innerR} 0 ${large} 0 ${ix1} ${iy1} Z`;
                                    const midAngle = cumAngle + angle / 2;
                                    cumAngle += angle;
                                    return { k, v, d, color: CATEGORIES[k]?.color || '#888', pct: Math.round(v / total * 100), midAngle };
                                });
                                return (
                                    <div className="glass p-4 rounded-xl">
                                        <div className="text-[10px] text-gray-500 mb-3">Êï∞ÊçÆÊëòË¶Å ¬∑ ÂÖ± {total}m</div>
                                        <div className="flex items-center gap-4">
                                            <svg width="160" height="160" viewBox="0 0 160 160" className="shrink-0">
                                                {slices.map((s, i) => (
                                                    <path key={i} d={s.d} fill={s.color} opacity="0.85" />
                                                ))}
                                                {/* ‰∏≠ÂøÉÊòæÁ§∫ÊÄªÊó∂Èïø */}
                                                <text x="80" y="76" textAnchor="middle" fontSize="13" fontWeight="bold" fill="#00ff41">{total}</text>
                                                <text x="80" y="90" textAnchor="middle" fontSize="9" fill="#666">ÂàÜÈíü</text>
                                            </svg>
                                            <div className="flex flex-col gap-2 flex-1 min-w-0">
                                                {slices.map((s) => (
                                                    <div key={s.k} className="flex items-center gap-2">
                                                        <span className="w-2 h-2 rounded-full shrink-0" style={{background: s.color}}></span>
                                                        <span className="text-[10px] truncate flex-1" style={{color: s.color}}>{CATEGORIES[s.k]?.label}</span>
                                                        <span className="text-[10px] text-gray-400 shrink-0">{s.v}m</span>
                                                        <span className="text-[9px] shrink-0" style={{color: s.color}}>{s.pct}%</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}

                            {/* ÂèëËµ∑ÂàÜÊûêÊåâÈíÆ */}
                            {reviewMessages.length === 0 && (
                                <button onClick={startReview} disabled={reviewLoading} className="w-full py-3 bg-[#00ff41] text-black font-bold rounded text-sm disabled:opacity-50">
                                    {reviewLoading ? 'ÂàÜÊûê‰∏≠...' : 'ü§ñ ÂºÄÂßã AI Â§çÁõòÂàÜÊûê'}
                                </button>
                            )}

                            {/* ÂØπËØùÂå∫ */}
                            {reviewMessages.length > 0 && (
                                <div className="space-y-4">
                                    {reviewMessages.map((msg, idx) => (
                                        <div key={idx} className={`rounded-xl p-4 ${msg.role === 'user' ? 'glass border-gray-800' : 'glass border-[#00ff41]/20'}`}>
                                            {msg.role === 'user'
                                                ? <div className="text-[11px] text-gray-400">{msg.text}</div>
                                                : renderMarkdown(msg.text)
                                            }
                                        </div>
                                    ))}
                                    {reviewLoading && <div className="text-center text-[11px] text-gray-500 animate-pulse py-4">AI ÂàÜÊûê‰∏≠...</div>}

                                    {/* ÈáçÊñ∞ÂàÜÊûê + ËøΩÈóÆ */}
                                    {!reviewLoading && (
                                        <div className="space-y-3">
                                            <div className="flex gap-2 items-end">
                                                <textarea
                                                    placeholder="ÁªßÁª≠ËøΩÈóÆ..."
                                                    value={reviewInput}
                                                    onChange={e => setReviewInput(e.target.value)}
                                                    onKeyDown={e => { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendFollowUp(); }}}
                                                    rows="1"
                                                    className="auto-resize-textarea flex-1 text-xs border-b border-gray-700 py-2"
                                                />
                                                <button onClick={sendFollowUp} disabled={!reviewInput.trim()} className="px-4 py-2 bg-[#00ff41] text-black text-xs font-bold rounded disabled:opacity-30">ÂèëÈÄÅ</button>
                                            </div>
                                            <button onClick={() => { setReviewMessages([]); }} className="w-full py-2 border border-gray-800 text-gray-500 rounded text-[10px]">ÈáçÊñ∞ÂàÜÊûê</button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Â∫ïÈÉ® Tab Ê†è */}
                    <div className="tab-bar">
                        <div className="max-w-md mx-auto flex">
                            {[{id:'log',icon:'‚è±',label:'ËÆ∞ÂΩï'},{id:'review',icon:'ü§ñ',label:'Â§çÁõò'}].map(t => (
                                <button key={t.id} onClick={() => setActiveTab(t.id)} className={`flex-1 py-3 flex flex-col items-center gap-0.5 transition-all ${activeTab===t.id ? 'text-[#00ff41]' : 'text-gray-600'}`}>
                                    <span className="text-base">{t.icon}</span>
                                    <span className="text-[9px]">{t.label}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
