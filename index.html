<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êó∂Èó¥ÁÇºÈáëÊúØ v1.5.0</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains+Mono', monospace; background-color: #0a0a0a; color: #00ff41; min-height: 100vh; }
        .glass { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); border: 1px solid #333; }
        input, select, textarea { background: #1a1a1a !important; color: #00ff41 !important; border: 1px solid #444 !important; border-radius: 4px; padding: 6px 10px; outline: none; }
        .save-btn { background: #00ff41; color: #000; font-weight: bold; }
        .edit-btn { color: #666; border: 1px solid #333; font-size: 10px; padding: 2px 8px; border-radius: 4px; }
        .idea-card { border: 1px dashed #eab308; background: rgba(234, 179, 8, 0.05); }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        .auto-resize-textarea { field-sizing: content; min-height: 1.5rem; resize: none; border: none !important; background: transparent !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const CATEGORIES = {
            CORE: { id: 'CORE', label: '‰∫§ÊòìÁ†îÁ©∂', color: '#00ff41' },
            AI: { id: 'AI', label: 'AIÊé¢Á¥¢', color: '#0ea5e9' },
            FAMILY: { id: 'FAMILY', label: 'ÂÆ∂Â∫≠Êó∂ÂÖâ', color: '#ec4899' },
            RECREATION: { id: 'RECREATION', label: '‰ºëÈó≤Â®±‰πê', color: '#8b5cf6' },
            WASTE: { id: 'WASTE', label: 'Êó†ÊïàÊçüËÄó', color: '#ef4444' },
            RECHARGE: { id: 'RECHARGE', label: 'ËÉΩÈáèÂÖÖÁîµ', color: '#eab308' },
            IDEA: { id: 'IDEA', label: 'Âç≥Êó∂ÊÉ≥Ê≥ï', color: '#eab308' }
        };

        // P1: ÁîüÊàêÂîØ‰∏ÄIDÔºåÈò≤Ê≠¢È´òÈ¢ëÁÇπÂáªÁ¢∞Êíû
        const generateId = () => {
            return typeof crypto.randomUUID === 'function' 
                ? crypto.randomUUID() 
                : Date.now().toString(36) + Math.random().toString(36).substring(2);
        };

        const App = () => {
            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('timeLogs') || '[]'));
            const [activeTask, setActiveTask] = useState(() => JSON.parse(localStorage.getItem('activeTask') || 'null'));
            const [config, setConfig] = useState(() => JSON.parse(localStorage.getItem('syncConfig') || '{"token":"","gistId":""}'));
            
            const [showSettings, setShowSettings] = useState(false);
            const [syncing, setSyncing] = useState(false);
            const [feeling, setFeeling] = useState('');
            const [ideaText, setIdeaText] = useState('');
            const [currentCategory, setCurrentCategory] = useState('CORE');
            const [editingId, setEditingId] = useState(null);
            const [editDraft, setEditDraft] = useState(null);
            const [showBackfill, setShowBackfill] = useState(false);
            const [backfillData, setBackfillData] = useState({ start: "", end: "" });

            // P2: ËÅåË¥£ÊãÜÂàÜÔºå‰ºòÂåñÂÜôÂÖ•ÊÄßËÉΩ
            useEffect(() => { localStorage.setItem('timeLogs', JSON.stringify(logs)); }, [logs]);
            useEffect(() => { localStorage.setItem('activeTask', JSON.stringify(activeTask)); }, [activeTask]);
            useEffect(() => { localStorage.setItem('syncConfig', JSON.stringify(config)); }, [config]);

            // P2: ÂêàÂπ∂ filter ‰∏é sort Ëøõ useMemoÔºåÂáèÂ∞ëÈáçÁªòËÆ°ÁÆó
            const displayLogs = useMemo(() => {
                return logs.filter(l => !l.deleted).sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            }, [logs]);

            // P1: ‰øÆÊ≠£Êó∂Âå∫ÈÄªËæëÊ≥®ÈáäÔºögetTimezoneOffset() Âú® UTC+8 ËøîÂõû -480
            const toLocalISO = (isoString) => {
                if (!isoString) return "";
                const d = new Date(isoString);
                return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            };

            const formatTimeOnly = (isoString) => {
                const date = new Date(isoString);
                return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            };

            const formatDateTime = (isoString) => {
                const date = new Date(isoString);
                return `${date.getMonth()+1}/${date.getDate()} ${formatTimeOnly(isoString)}`;
            };

            // P0: Ê†∏ÂøÉÈáçÊûÑÔºösyncData Êé•Êî∂ÂèÇÊï∞ÔºåËß£ÂÜ≥Á´ûÊÄÅÈóÆÈ¢ò
            const syncData = async (currentLogs, mode = 'sync', silent = false) => {
                if (!config.token || !config.gistId) return;
                setSyncing(true);
                try {
                    const response = await fetch(`https://api.github.com/gists/${config.gistId}?_t=${Date.now()}`, {
                        headers: { 'Authorization': `token ${config.token}` },
                        cache: 'no-store'
                    });
                    
                    let cloudContent = [];
                    if (response.ok) {
                        const gistData = await response.json();
                        const content = gistData.files['data.json']?.content;
                        if (content) cloudContent = JSON.parse(content);
                    }

                    let finalLogs = [];
                    if (mode === 'pull') {
                        finalLogs = cloudContent;
                    } else {
                        // ÂêàÂπ∂ÈÄªËæëÔºö‰ª• updatedAt ‰∏∫ÂáÜ
                        const uniqueMap = new Map();
                        [...cloudContent, ...currentLogs].forEach(item => {
                            if (!item.id) return;
                            const existing = uniqueMap.get(item.id);
                            if (!existing || (item.updatedAt || 0) > (existing.updatedAt || 0)) {
                                uniqueMap.set(item.id, item);
                            }
                        });
                        finalLogs = Array.from(uniqueMap.values());
                    }

                    await fetch(`https://api.github.com/gists/${config.gistId}`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ files: { 'data.json': { content: JSON.stringify(finalLogs) } } })
                    });

                    setLogs(finalLogs);
                    if (!silent) alert("‰∫ëÁ´ØÂêåÊ≠•ÊàêÂäü");
                } catch (err) {
                    if (!silent) alert("ÂêåÊ≠•Â§±Ë¥•: " + err.message);
                } finally { setSyncing(false); }
            };

            // P1: ÂçáÁ∫ßÁé∞‰ª£ Clipboard API
            const exportData = async () => {
                let lastDate = "";
                const exportText = displayLogs.map(log => {
                    const dateObj = new Date(log.startTime);
                    const currentDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
                    let datePrefix = (currentDate !== lastDate) ? `\n[--- ${currentDate} ---]\n` : "";
                    lastDate = currentDate;

                    return log.category === 'IDEA' 
                        ? `${datePrefix}${formatTimeOnly(log.startTime)} | ${log.feeling}`
                        : `${datePrefix}${formatTimeOnly(log.startTime)} | ${formatTimeOnly(log.endTime)} | ${CATEGORIES[log.category]?.label} | ${log.feeling}`;
                }).join('\n');

                try {
                    await navigator.clipboard.writeText(exportText.trim());
                    alert("Â∑≤ÊåâÁÖßÊó∂Èó¥ÂÄíÂ∫èÂ§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ");
                } catch (err) {
                    alert("Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®ÈÄâÊã©Â§çÂà∂„ÄÇ");
                }
            };

            const stopTask = () => {
                if (!activeTask) return;
                const now = new Date();
                const completedTask = { 
                    ...activeTask, 
                    category: currentCategory, 
                    feeling: feeling || activeTask.feeling || "", 
                    endTime: now.toISOString(), 
                    duration: Math.max(1, Math.round((now - new Date(activeTask.startTime)) / 1000 / 60)), 
                    updatedAt: Date.now() 
                };
                const newLogs = [completedTask, ...logs];
                setLogs(newLogs);
                setActiveTask(null);
                setFeeling('');
                syncData(newLogs, 'sync', true); // P0: ‰º†ÂèÇÂêåÊ≠•
            };

            const saveQuickIdea = () => {
                if (!ideaText.trim()) return;
                const newLogs = [{ 
                    id: generateId(), 
                    category: 'IDEA', 
                    startTime: new Date().toISOString(), 
                    endTime: new Date().toISOString(), 
                    feeling: ideaText, 
                    duration: 0, 
                    updatedAt: Date.now() 
                }, ...logs];
                setLogs(newLogs);
                setIdeaText('');
                syncData(newLogs, 'sync', true);
            };

            const confirmBackfill = () => {
                const s = new Date(backfillData.start);
                const e = new Date(backfillData.end);
                const newLogs = [{ 
                    id: generateId(), 
                    category: currentCategory, 
                    startTime: s.toISOString(), 
                    endTime: e.toISOString(), 
                    duration: Math.max(1, Math.round((e - s) / 1000 / 60)), 
                    feeling: feeling || "", 
                    updatedAt: Date.now() 
                }, ...logs];
                setLogs(newLogs);
                setFeeling(''); 
                setShowBackfill(false);
                syncData(newLogs, 'sync', true);
            };

            return (
                <div className="max-w-md mx-auto p-4 pb-20">
                    <header className="mb-6 pt-4 flex justify-between items-center border-b border-gray-900 pb-4">
                        <h1 className="text-xl font-bold text-[#00ff41]">Êó∂Èó¥ÁÇºÈáëÊúØ v1.5.0</h1>
                        <div className="flex items-center gap-3">
                            <span className="text-[9px] text-gray-500">{syncing ? 'ÂêåÊ≠•‰∏≠...' : 'Âú®Á∫ø'}</span>
                            <button onClick={() => setShowSettings(!showSettings)} className="text-gray-500 text-xl">‚öôÔ∏è</button>
                        </div>
                    </header>

                    {showSettings && (
                        <div className="glass p-5 rounded-xl mb-6 border-blue-500/50">
                            <div className="space-y-4 text-xs">
                                <input type="password" value={config.token} onChange={e => setConfig({...config, token: e.target.value})} placeholder="GitHub Token" className="w-full" />
                                <input type="text" value={config.gistId} onChange={e => setConfig({...config, gistId: e.target.value})} placeholder="Gist ID" className="w-full" />
                                <div className="flex gap-2">
                                    <button onClick={() => syncData(logs, 'pull')} className="btn-action bg-gray-800 text-white flex-1 py-2 rounded">‰ªé‰∫ëÁ´ØË¶ÜÁõñ</button>
                                    <button onClick={() => setShowSettings(false)} className="save-btn flex-1 py-2 rounded">‰øùÂ≠òÂπ∂ÂÖ≥Èó≠</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {!editingId && (
                        <div className="space-y-4 mb-8">
                            <div className="glass p-3 rounded-xl border-dashed border-[#eab308]/40 flex items-end gap-2">
                                <textarea 
                                    placeholder="üí° ËÆ∞ÂΩïÁû¨Èó¥ÁöÑ‰∫§ÊòìÁõ¥Ëßâ..." 
                                    value={ideaText} 
                                    onChange={e => setIdeaText(e.target.value)} 
                                    onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); saveQuickIdea(); } }}
                                    rows="1"
                                    className="auto-resize-textarea flex-1 text-xs py-1"
                                />
                                <button onClick={saveQuickIdea} className="bg-[#eab308] text-black px-3 py-1.5 rounded text-xs font-bold shrink-0 mb-0.5">ËÆ∞‰∏ã</button>
                            </div>

                            <div className="glass p-5 rounded-xl border-[#00ff41]/20">
                                <div className="grid grid-cols-3 gap-2 mb-4">
                                    {Object.values(CATEGORIES).filter(c => c.id !== 'IDEA').map(cat => (
                                        <button key={cat.id} onClick={() => setCurrentCategory(cat.id)} className={`text-[10px] py-2 rounded border transition-all ${currentCategory === cat.id ? 'border-[#00ff41] bg-[#00ff41]/10 text-[#00ff41]' : 'border-gray-800 text-gray-500'}`}>{cat.label}</button>
                                    ))}
                                </div>
                                <input type="text" placeholder={activeTask ? "Ê≠£Âú®ËÆ°Êó∂ÔºöÂÜô‰∏ãÂΩìÂâçËøõÂ±ï..." : "Ë¶ÅÂÅö‰ªÄ‰πàÂÜÖÂÆπ..."} value={feeling} onChange={e => setFeeling(e.target.value)} className="w-full text-sm mb-4 bg-transparent border-b border-gray-800 pb-1" />
                                {!activeTask ? (
                                    <div className="space-y-3">
                                        <button onClick={() => { setActiveTask({ id: generateId(), category: currentCategory, startTime: new Date().toISOString(), feeling, updatedAt: Date.now() }); setFeeling(''); }} className="w-full bg-[#00ff41] text-black font-bold py-3 rounded text-sm">ÂºÄÂßãËÆ∞ÂΩï</button>
                                        <div className="flex justify-center text-[10px] text-gray-500 gap-4">
                                            <button onClick={() => { setShowBackfill(!showBackfill); setBackfillData({start:toLocalISO(new Date(Date.now()-3600000).toISOString()), end:toLocalISO(new Date().toISOString())}) }} className="border-b border-gray-800">+ Ë°•ÂΩïÂéÜÂè≤</button>
                                        </div>
                                        {showBackfill && (
                                            <div className="mt-4 pt-4 border-t border-gray-800 animate-in fade-in duration-300">
                                                <div className="flex gap-2 mb-4">
                                                    {[15, 30, 60].map(m => <button key={m} onClick={() => { const now=new Date(); setBackfillData({start:toLocalISO(new Date(now.getTime()-m*60000).toISOString()), end:toLocalISO(now.toISOString())}) }} className="flex-1 py-1.5 border border-gray-700 rounded text-[10px]">{m}mÂâç</button>)}
                                                </div>
                                                <div className="space-y-2 mb-4 text-[10px]">
                                                    <div className="flex items-center gap-2"><span className="text-gray-500 w-8">ÂºÄÂßã</span><input type="datetime-local" value={backfillData.start} onChange={e => setBackfillData({...backfillData, start: e.target.value})} className="flex-1" /></div>
                                                    <div className="flex items-center gap-2"><span className="text-gray-500 w-8">ÁªìÊùü</span><input type="datetime-local" value={backfillData.end} onChange={e => setBackfillData({...backfillData, end: e.target.value})} className="flex-1" /></div>
                                                </div>
                                                <button onClick={confirmBackfill} className="w-full py-2 bg-gray-800 text-[#00ff41] rounded text-[10px] font-bold border border-[#00ff41]/30">Á°ÆËÆ§Ë°•ÂΩï</button>
                                            </div>
                                        )}
                                    </div>
                                ) : <button onClick={stopTask} className="w-full bg-red-600 text-white font-bold py-3 rounded text-sm animate-pulse">ÂÅúÊ≠¢Âπ∂ÂêåÊ≠•‰∫ëÁ´Ø</button>}
                            </div>
                        </div>
                    )}

                    <div className="flex justify-between items-center mb-4 px-1">
                        <h2 className="text-[10px] text-gray-500 font-bold uppercase tracking-widest">ÂéÜÂè≤Êó•Âøó</h2>
                        <button onClick={exportData} className="text-[10px] text-[#00ff41] border border-[#00ff41]/30 px-2 py-0.5 rounded">ÂØºÂá∫ÂÄíÂ∫èÊñáÊú¨</button>
                    </div>

                    <div className="space-y-3">
                        {displayLogs.map(log => (
                            <div key={log.id} className={`glass p-4 rounded-xl transition-all hover:border-gray-600 ${log.category === 'IDEA' ? 'idea-card' : ''}`}>
                                {editingId === log.id ? (
                                    <div className="space-y-4">
                                        <select value={editDraft.category} onChange={e => setEditDraft({...editDraft, category: e.target.value})} className="text-xs w-full">
                                            {Object.values(CATEGORIES).map(c => <option key={c.id} value={c.id}>{c.label}</option>)}
                                        </select>
                                        <textarea value={editDraft.feeling} onChange={e => setEditDraft({...editDraft, feeling: e.target.value})} className="w-full text-xs min-h-[80px]" />
                                        <div className="flex justify-between">
                                            <button onClick={() => { if(confirm("Âà†Èô§Ê≠§ËÆ∞ÂΩïÔºü")){ const newLogs=logs.map(l=>l.id===log.id?{...l, deleted:true, updatedAt:Date.now()}:l); setLogs(newLogs); setEditingId(null); syncData(newLogs,'sync',true); } }} className="text-[10px] text-red-500">Âà†Èô§</button>
                                            <div className="flex gap-2">
                                                <button onClick={() => setEditingId(null)} className="text-[10px] text-gray-500 px-2">ÂèñÊ∂à</button>
                                                <button onClick={() => { const newLogs=logs.map(l=>l.id===editingId?{...editDraft, updatedAt:Date.now()}:l); setLogs(newLogs); setEditingId(null); syncData(newLogs,'sync',true); }} className="text-[10px] text-[#00ff41] border border-[#00ff41] px-3 py-1 rounded">Êõ¥Êñ∞</button>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-[9px] font-bold px-1 rounded" style={{backgroundColor: CATEGORIES[log.category]?.color + '22', color: CATEGORIES[log.category]?.color}}>{CATEGORIES[log.category]?.label}</span>
                                                <span className="text-[9px] text-gray-600">{log.category === 'IDEA' ? formatDateTime(log.startTime) : `${formatDateTime(log.startTime)} - ${formatTimeOnly(log.endTime)}`}</span>
                                            </div>
                                            <div className="text-xs text-gray-300 leading-relaxed whitespace-pre-wrap">{log.feeling}</div>
                                        </div>
                                        <div className="flex flex-col items-end gap-2 ml-4 shrink-0">
                                            {log.category !== 'IDEA' && <div className="text-sm font-bold text-[#00ff41]">{log.duration}m</div>}
                                            <button onClick={() => { setEditingId(log.id); setEditDraft({...log}); }} className="edit-btn">ÁºñËæë</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
