<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间炼金术 v1.3.3 (Auto-Sync)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains+Mono', monospace; background-color: #0a0a0a; color: #00ff41; }
        .glass { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); border: 1px solid #333; }
        input, select { background: #1a1a1a !important; color: #00ff41 !important; border: 1px solid #444 !important; border-radius: 4px; padding: 6px 10px; outline: none; }
        input:focus { border-color: #00ff41 !important; }
        .btn-action { padding: 4px 12px; border-radius: 4px; font-size: 11px; font-weight: bold; transition: all 0.2s; }
        .save-btn { background: #00ff41; color: #000; }
        .cancel-btn { border: 1px solid #444; color: #666; }
        .sync-status { font-size: 10px; padding: 2px 6px; border-radius: 99px; }
        .idea-card { border: 1px dashed #eab308; background: rgba(234, 179, 8, 0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const CATEGORIES = {
            CORE: { id: 'CORE', label: '核心产出', color: '#00ff41' },
            OPS: { id: 'OPS', label: '交易运维', color: '#0ea5e9' },
            FAMILY: { id: 'FAMILY', label: '家庭时光', color: '#ec4899' },
            WASTE: { id: 'WASTE', label: '无效损耗', color: '#ef4444' },
            RECHARGE: { id: 'RECHARGE', label: '能量充电', color: '#eab308' },
            IDEA: { id: 'IDEA', label: '即时想法', color: '#eab308' }
        };

        const App = () => {
            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('timeLogs') || '[]'));
            const [activeTask, setActiveTask] = useState(() => JSON.parse(localStorage.getItem('activeTask') || 'null'));
            const [config, setConfig] = useState(() => JSON.parse(localStorage.getItem('syncConfig') || '{"token":"","gistId":""}'));
            
            const [showSettings, setShowSettings] = useState(false);
            const [syncing, setSyncing] = useState(false);
            const [feeling, setFeeling] = useState('');
            const [ideaText, setIdeaText] = useState('');
            const [scriptRoi, setScriptRoi] = useState(3);
            const [currentCategory, setCurrentCategory] = useState('CORE');
            const [editingId, setEditingId] = useState(null);
            const [editDraft, setEditDraft] = useState(null);

            // 本地持久化
            useEffect(() => {
                localStorage.setItem('timeLogs', JSON.stringify(logs));
                localStorage.setItem('activeTask', JSON.stringify(activeTask));
                localStorage.setItem('syncConfig', JSON.stringify(config));
            }, [logs, activeTask, config]);

            // --- 核心同步引擎 (带静默模式) ---
            const syncData = async (mode = 'sync', silent = false) => {
                if (!config.token || !config.gistId) return;
                setSyncing(true);
                try {
                    const timestamp = Date.now();
                    const response = await fetch(`https://api.github.com/gists/${config.gistId}?_t=${timestamp}`, {
                        headers: { 'Authorization': `token ${config.token}`, 'Accept': 'application/vnd.github.v3+json' },
                        cache: 'no-store'
                    });

                    let cloudContent = [];
                    if (response.ok) {
                        const gistData = await response.json();
                        const fileContent = gistData.files['data.json']?.content;
                        if (fileContent) {
                            const parsed = JSON.parse(fileContent);
                            cloudContent = Array.isArray(parsed) ? parsed : [];
                        }
                    }

                    let finalLogs;
                    if (mode === 'pull') {
                        finalLogs = cloudContent;
                    } else {
                        const combined = [...logs, ...cloudContent];
                        const uniqueMap = new Map();
                        combined.forEach(item => { if (item && item.id) uniqueMap.set(item.id, item); });
                        finalLogs = Array.from(uniqueMap.values()).sort((a, b) => b.id - a.id);
                    }

                    await fetch(`https://api.github.com/gists/${config.gistId}`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ files: { 'data.json': { content: JSON.stringify(finalLogs) } } })
                    });

                    setLogs(finalLogs);
                    if (!silent) alert("云端数据已同步");
                } catch (err) {
                    console.error(err);
                    if (!silent) alert("同步失败: " + err.message);
                } finally {
                    setSyncing(false);
                }
            };

            // --- 操作函数 (触发自动同步) ---
            const startTask = () => {
                if (activeTask) stopTask();
                const now = new Date();
                setActiveTask({ id: Date.now(), category: currentCategory, startTime: now.toISOString(), scriptRoi: currentCategory === 'OPS' ? scriptRoi : null, feeling });
                setFeeling('');
            };

            const stopTask = () => {
                if (!activeTask) return;
                const now = new Date();
                const completedTask = { ...activeTask, endTime: now.toISOString(), duration: Math.max(1, Math.round((now - new Date(activeTask.startTime)) / 1000 / 60)) };
                const newLogs = [completedTask, ...logs];
                setLogs(newLogs);
                setActiveTask(null);
                setTimeout(() => syncData('sync', true), 500); // 停止后自动静默同步
            };

            const saveQuickIdea = () => {
                if (!ideaText.trim()) return;
                const newIdea = { id: Date.now(), category: 'IDEA', startTime: new Date().toISOString(), feeling: ideaText, duration: 0 };
                setLogs([newIdea, ...logs]);
                setIdeaText('');
                setTimeout(() => syncData('sync', true), 500); // 保存想法后同步
            };

            const openEdit = (log) => {
                setEditingId(log.id);
                setEditDraft({ ...log });
            };
