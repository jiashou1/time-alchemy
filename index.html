<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êó∂Èó¥ÁÇºÈáëÊúØ v1.5.6</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains+Mono', monospace; background-color: #0a0a0a; color: #00ff41; min-height: 100vh; }
        .glass { background: rgba(20, 20, 20, 0.8); backdrop-filter: blur(10px); border: 1px solid #333; }
        input, select, textarea { background: #1a1a1a !important; color: #00ff41 !important; border: 1px solid #444 !important; border-radius: 4px; padding: 6px 10px; outline: none; }
        .save-btn { background: #00ff41; color: #000; font-weight: bold; }
        .edit-btn { color: #666; border: 1px solid #333; font-size: 10px; padding: 2px 8px; border-radius: 4px; }
        .idea-card { border: 1px dashed #eab308; background: rgba(234, 179, 8, 0.05); }
        .q-tag { font-size: 9px; padding: 2px 8px; border-radius: 99px; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; cursor: pointer; }
        .active-tag { background: #00ff4122; color: #00ff41; border-color: #00ff4155; }
        .highlight-tag { font-size: 9px; padding: 1px 6px; border-radius: 99px; background: rgba(0, 255, 65, 0.15); color: #00ff41; border: 1px solid rgba(0, 255, 65, 0.3); margin-right: 4px; }
        .auto-resize-textarea { field-sizing: content; min-height: 1.5rem; resize: none; border: none !important; background: transparent !important; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CATEGORIES = {
            CORE: { id: 'CORE', label: '‰∫§ÊòìÁ†îÁ©∂', color: '#00ff41' },
            AI: { id: 'AI', label: 'AIÊé¢Á¥¢', color: '#0ea5e9' },
            FAMILY: { id: 'FAMILY', label: 'ÂÆ∂Â∫≠Êó∂ÂÖâ', color: '#ec4899' },
            RECREATION: { id: 'RECREATION', label: '‰ºëÈó≤Â®±‰πê', color: '#8b5cf6' },
            WASTE: { id: 'WASTE', label: 'Êó†ÊïàÊçüËÄó', color: '#ef4444' },
            RECHARGE: { id: 'RECHARGE', label: 'Êó•Â∏∏‰ª£Ë∞¢', color: '#eab308' },
            IDEA: { id: 'IDEA', label: 'Âç≥Êó∂ÊÉ≥Ê≥ï', color: '#eab308' }
        };

        const DEFAULT_TAGS = "‰∫§ÊòìÁ†îÁ©∂:Â§çÁõò,ÁõØÁõò,ÂºÄ‰ªì;AIÊé¢Á¥¢:ÊèêÁ§∫ËØç,ÊµãËØï,ÈòÖËØª;ÂÆ∂Â∫≠Êó∂ÂÖâ:ÈÖçÂÅ∂,Â≠©Â≠ê,Áà∂ÊØç;Êó•Â∏∏‰ª£Ë∞¢:Áù°Ëßâ,È•ÆÈ£ü,Ê¥óÊº±,Â¶ÇÂéï";

        const generateId = () => typeof crypto.randomUUID === 'function' ? crypto.randomUUID() : Date.now().toString(36) + Math.random().toString(36).substring(2);

        const App = () => {
            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('timeLogs') || '[]'));
            const [activeTask, setActiveTask] = useState(() => JSON.parse(localStorage.getItem('activeTask') || 'null'));
            const [config, setConfig] = useState(() => JSON.parse(localStorage.getItem('syncConfig') || `{"token":"","gistId":"","tagMap":"${DEFAULT_TAGS}"}`));
            const [syncing, setSyncing] = useState(false);
            const [feeling, setFeeling] = useState('');
            const [ideaText, setIdeaText] = useState('');
            const [currentCategory, setCurrentCategory] = useState('CORE');
            const [selectedQuickTags, setSelectedQuickTags] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [editDraft, setEditDraft] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [showBackfill, setShowBackfill] = useState(false);
            const [backfillData, setBackfillData] = useState({ start: "", end: "" });

            useEffect(() => { localStorage.setItem('timeLogs', JSON.stringify(logs)); }, [logs]);
            useEffect(() => { localStorage.setItem('activeTask', JSON.stringify(activeTask)); }, [activeTask]);
            useEffect(() => { localStorage.setItem('syncConfig', JSON.stringify(config)); }, [config]);

            const displayLogs = useMemo(() => logs.filter(l => !l.deleted).sort((a, b) => new Date(b.startTime) - new Date(a.startTime)), [logs]);

            const currentSubTags = useMemo(() => {
                const label = CATEGORIES[currentCategory]?.label;
                if (!config.tagMap || !label) return [];
                const parts = config.tagMap.split(';');
                const target = parts.find(p => p.trim().startsWith(label));
                return target ? target.split(':')[1].split(',').map(t => t.trim()) : [];
            }, [currentCategory, config.tagMap]);

            const toLocalISO = (iso) => {
                if (!iso) return "";
                const d = new Date(iso);
                return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            };
            const formatTime = (iso) => { const d = new Date(iso); return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; };
            const formatDT = (iso) => { const d = new Date(iso); return `${d.getMonth()+1}/${d.getDate()} ${formatTime(iso)}`; };

            const syncData = async (currLogs, mode = 'sync') => {
                if (!config.token || !config.gistId) return;
                setSyncing(true);
                try {
                    const res = await fetch(`https://api.github.com/gists/${config.gistId}?_t=${Date.now()}`, { headers: { 'Authorization': `token ${config.token}` }, cache: 'no-store' });
                    let cloud = []; 
                    if (res.ok) { 
                        const d = await res.json(); 
                        cloud = JSON.parse(d.files['data.json']?.content || '[]'); 
                    }
                    let final;
                    if (mode === 'pull') {
                        final = cloud;
                    } else {
                        const map = new Map(); 
                        [...cloud, ...currLogs].forEach(i => { 
                            if(i.id && (!map.has(i.id) || (i.updatedAt||0) > (map.get(i.id).updatedAt||0))) map.set(i.id, i); 
                        });
                        final = Array.from(map.values());
                    }
                    if (mode !== 'pull') {
                        await fetch(`https://api.github.com/gists/${config.gistId}`, {
                            method: 'PATCH', headers: { 'Authorization': `token ${config.token}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ files: { 'data.json': { content: JSON.stringify(final) } } })
                        });
                    }
                    setLogs(final);
                    if (mode === 'pull') alert("‰∫ëÁ´ØÊï∞ÊçÆÂêåÊ≠•ÊàêÂäü");
                } catch (e) { alert("ÂêåÊ≠•Â§±Ë¥•: " + e.message); } finally { setSyncing(false); }
            };

            const stopTask = () => {
                const now = new Date();
                const prefix = selectedQuickTags.length > 0 ? `[@${selectedQuickTags.join('/')}] ` : "";
                const newTask = { ...activeTask, category: currentCategory, feeling: prefix + feeling, endTime: now.toISOString(), duration: Math.max(1, Math.round((now - new Date(activeTask.startTime)) / 60000)), updatedAt: Date.now() };
                const newLogs = [newTask, ...logs];
                setLogs(newLogs); setActiveTask(null); setFeeling(''); setSelectedQuickTags([]); syncData(newLogs);
            };

            const renderContent = (text) => {
                const match = text.match(/^\[@(.+?)\]\s*(.*)/);
                if (match) {
                    return (
                        <div className="text-xs">
                            <div className="flex flex-wrap gap-1 mb-1">{match[1].split('/').map(m => <span key={m} className="highlight-tag">{m}</span>)}</div>
                            <div className="text-gray-300 break-words whitespace-pre-wrap">{match[2]}</div>
                        </div>
                    );
                }
                return <div className="text-xs text-gray-300 break-words whitespace-pre-wrap">{text}</div>;
            };

            return (
                <div className="max-w-md mx-auto p-4 pb-20">
                    <header className="mb-6 pt-4 flex justify-between items-center border-b border-gray-900 pb-4">
                        <h1 className="text-xl font-bold text-[#00ff41]">Êó∂Èó¥ÁÇºÈáëÊúØ v1.5.6</h1>
                        <div className="flex items-center gap-3">
                            <span className="text-[9px] text-gray-500">{syncing ? 'ÂêåÊ≠•‰∏≠...' : 'Âú®Á∫ø'}</span>
                            <button onClick={() => setShowSettings(!showSettings)} className="text-gray-500 text-xl">‚öôÔ∏è</button>
                        </div>
                    </header>

                    {showSettings && (
                        <div className="glass p-5 rounded-xl mb-6 border-blue-500/50 text-[10px] space-y-4">
                            <input type="password" value={config.token} onChange={e => setConfig({...config, token: e.target.value})} placeholder="GitHub Token" className="w-full" />
                            <input type="text" value={config.gistId} onChange={e => setConfig({...config, gistId: e.target.value})} placeholder="Gist ID" className="w-full" />
                            <div>
                                <label className="text-gray-500 block mb-1">ÂÖ®Ê†áÁ≠æÂø´Êç∑ÈÖçÁΩÆ (ÂàÜÁ±ª:È°π,È°π; ÂàÜÁ±ª2:...)</label>
                                <textarea value={config.tagMap} onChange={e => setConfig({...config, tagMap: e.target.value})} className="w-full h-24 text-[9px] p-2 bg-black" />
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => syncData(logs, 'pull')} className="bg-gray-800 text-white flex-1 py-2 rounded">‰ªé‰∫ëÁ´ØË¶ÜÁõñ</button>
                                <button onClick={() => setShowSettings(false)} className="save-btn flex-1 py-2 rounded text-black font-bold">‰øùÂ≠òÂπ∂ÂÖ≥Èó≠</button>
                            </div>
                        </div>
                    )}

                    {!editingId && ( activeTask ? (
                        <div className="glass p-5 rounded-xl border-[#00ff41]/40 mb-8 animate-in fade-in duration-300">
                            <div className="flex justify-between items-center mb-4">
                                <span className="text-[10px] font-bold text-[#00ff41] bg-[#00ff41]/10 px-2 py-0.5 rounded">{CATEGORIES[currentCategory].label}</span>
                                <span className="text-xs animate-pulse text-red-500 font-bold">Ê≠£Âú®ËÆ°Êó∂...</span>
                            </div>
                            {currentSubTags.length > 0 && (
                                <div className="flex flex-wrap gap-2 mb-4">
                                    {currentSubTags.map(t => (
                                        <button key={t} onClick={() => setSelectedQuickTags(p => p.includes(t) ? p.filter(x => x!==t) : [...p, t])} className={`q-tag ${selectedQuickTags.includes(t) ? 'active-tag' : 'text-gray-500'}`}>{t}</button>
                                    ))}
                                </div>
                            )}
                            <textarea placeholder="Ë°•ÂÖÖÊ≠§Êó∂ÁªÜËäÇ..." value={feeling} onChange={e => setFeeling(e.target.value)} rows="1" className="auto-resize-textarea w-full text-sm mb-4 border-b border-gray-800 leading-relaxed" />
                            <button onClick={stopTask} className="w-full bg-red-600 text-white font-bold py-3 rounded text-sm shadow-lg shadow-red-900/20">ÁªìÊùüÂπ∂ÂêåÊ≠•</button>
                        </div>
                    ) : (
                        <div className="space-y-4 mb-8">
                            <div className="glass p-3 rounded-xl border-dashed border-[#eab308]/40 flex items-end gap-2">
                                <textarea placeholder="üí° Áû¨Êó∂ÊÉ≥Ê≥ï..." value={ideaText} onChange={e => setIdeaText(e.target.value)} className="auto-resize-textarea flex-1 text-xs py-1" />
                                <button onClick={() => { if(!ideaText.trim())return; const n=[{id:generateId(),category:'IDEA',startTime:new Date().toISOString(),endTime:new Date().toISOString(),feeling:ideaText,updatedAt:Date.now()},...logs]; setLogs(n); setIdeaText(''); syncData(n); }} className="bg-[#eab308] text-black px-3 py-1.5 rounded text-xs font-bold">ËÆ∞‰∏ã</button>
                            </div>
                            <div className="glass p-5 rounded-xl">
                                <div className="grid grid-cols-3 gap-2 mb-4">
                                    {Object.values(CATEGORIES).filter(c=>c.id!=='IDEA').map(c => (
                                        <button key={c.id} onClick={() => {setCurrentCategory(c.id); setSelectedQuickTags([]);}} className={`text-[10px] py-2 rounded border transition-all ${currentCategory === c.id ? 'border-[#00ff41] bg-[#00ff41]/10 text-[#00ff41]' : 'border-gray-800 text-gray-500'}`}>{c.label}</button>
                                    ))}
                                </div>
                                <div className="space-y-3">
                                    <button onClick={() => setActiveTask({ id: generateId(), category: currentCategory, startTime: new Date().toISOString(), updatedAt: Date.now() })} className="w-full bg-[#00ff41] text-black font-bold py-3 rounded text-sm">ÂºÄÂßãËÆ∞ÂΩï</button>
                                    <div className="flex justify-center text-[10px] text-gray-500">
                                        <button onClick={() => { setShowBackfill(!showBackfill); setBackfillData({start:toLocalISO(new Date(Date.now()-3600000).toISOString()), end:toLocalISO(new Date().toISOString())}) }} className="border-b border-gray-800 text-gray-400 hover:text-[#00ff41] transition-colors">+ Ë°•ÂΩïÂéÜÂè≤</button>
                                    </div>
                                    {showBackfill && (
                                        <div className="mt-4 pt-4 border-t border-gray-800 space-y-4 animate-in slide-in-from-top-2">
                                            <div className="flex gap-2">{[15, 30, 60].map(m => <button key={m} onClick={() => { const now=new Date(); setBackfillData({start:toLocalISO(new Date(now.getTime()-m*60000).toISOString()), end:toLocalISO(now.toISOString())}) }} className="flex-1 py-1.5 border border-gray-700 rounded text-[10px] active:bg-[#00ff41]/10">{m}mÂâç</button>)}</div>
                                            <div className="space-y-2 text-[10px]">
                                                <div className="flex items-center gap-2 text-gray-500"><span>ÂºÄÂßã</span><input type="datetime-local" value={backfillData.start} onChange={e => setBackfillData({...backfillData, start: e.target.value})} className="flex-1" /></div>
                                                <div className="flex items-center gap-2 text-gray-500"><span>ÁªìÊùü</span><input type="datetime-local" value={backfillData.end} onChange={e => setBackfillData({...backfillData, end: e.target.value})} className="flex-1" /></div>
                                            </div>
                                            <button onClick={() => { const s=new Date(backfillData.start); const e=new Date(backfillData.end); const n=[{id:generateId(), category:currentCategory, startTime:s.toISOString(), endTime:e.toISOString(), duration:Math.max(1,Math.round((e-s)/60000)), feeling, updatedAt:Date.now()}, ...logs]; setLogs(n); setFeeling(''); setShowBackfill(false); syncData(n); }} className="w-full py-2 bg-gray-800 text-[#00ff41] rounded text-[10px] font-bold border border-[#00ff41]/30">Á°ÆËÆ§Ë°•ÂΩï</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}

                    <div className="flex justify-between items-center mb-4 px-1 text-[10px] text-gray-500 font-bold tracking-widest uppercase"><h2>ÂéÜÂè≤Êó•Âøó</h2></div>

                    <div className="space-y-3">
                        {displayLogs.map(log => (
                            <div key={log.id} className={`glass p-4 rounded-xl transition-all ${log.category === 'IDEA' ? 'idea-card' : 'border-gray-800 hover:border-gray-700'}`}>
                                {editingId === log.id ? (
                                    <div className="space-y-4">
                                        <select value={editDraft.category} onChange={e => setEditDraft({...editDraft, category: e.target.value})} className="text-xs w-full">
                                            {Object.values(CATEGORIES).map(c => <option key={c.id} value={c.id}>{c.label}</option>)}
                                        </select>
                                        <div className="space-y-2 bg-black/20 p-2 rounded border border-gray-800">
                                            <input type="datetime-local" value={toLocalISO(editDraft.startTime)} onChange={e => setEditDraft({...editDraft, startTime: new Date(e.target.value).toISOString()})} className="w-full text-[10px] bg-transparent border-none" />
                                            {editDraft.category !== 'IDEA' && <input type="datetime-local" value={toLocalISO(editDraft.endTime)} onChange={e => setEditDraft({...editDraft, endTime: new Date(e.target.value).toISOString()})} className="w-full text-[10px] bg-transparent border-none" />}
                                        </div>
                                        <textarea value={editDraft.feeling} onChange={e => setEditDraft({...editDraft, feeling: e.target.value})} className="w-full text-xs min-h-[80px] leading-relaxed" />
                                        <div className="flex justify-end gap-2 items-center">
                                            <button onClick={() => { if(confirm("Âà†Èô§Ê≠§ËÆ∞ÂΩïÔºü")){ const n=logs.map(l=>l.id===log.id?{...l, deleted:true, updatedAt:Date.now()}:l); setLogs(n); setEditingId(null); syncData(n); } }} className="text-[10px] text-red-500 px-3 py-1 hover:bg-red-500/10 rounded">Âà†Èô§</button>
                                            <button onClick={() => setEditingId(null)} className="text-[10px] px-3 py-1 text-gray-500">ÂèñÊ∂à</button>
                                            <button onClick={() => { const s=new Date(editDraft.startTime); const e=new Date(editDraft.endTime); const nDur=editDraft.category==='IDEA'?0:Math.max(1,Math.round((e-s)/60000)); const n=logs.map(l=>l.id===editingId?{...editDraft, duration:nDur, updatedAt:Date.now()}:l); setLogs(n); setEditingId(null); syncData(n); }} className="text-[10px] text-[#00ff41] border border-[#00ff41] px-4 py-1 rounded font-bold">‰øùÂ≠ò‰øÆÊîπ</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1 overflow-hidden">
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className="text-[9px] font-bold px-1.5 py-0.5 rounded" style={{backgroundColor: CATEGORIES[log.category]?.color+'22', color: CATEGORIES[log.category]?.color}}>{CATEGORIES[log.category]?.label}</span>
                                                <span className="text-[9px] text-gray-600">{log.category==='IDEA'?formatDT(log.startTime):`${formatDT(log.startTime)} - ${formatTime(log.endTime)}`}</span>
                                            </div>
                                            {renderContent(log.feeling)}
                                        </div>
                                        <div className="flex flex-col items-end shrink-0 ml-4 gap-2">
                                            {log.category!=='IDEA' && <div className="text-sm font-bold text-[#00ff41]">{log.duration}m</div>}
                                            <button onClick={() => {setEditingId(log.id); setEditDraft({...log});}} className="edit-btn hover:text-white hover:border-gray-500 transition-colors">ÁºñËæë</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
